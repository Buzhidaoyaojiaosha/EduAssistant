{% extends 'base.html' %}

{% block title %}{{ course.name }} - 教学分析助手{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2>{{ course.name }}</h2>
        <p class="text-muted">课程代码: {{ course.code }}</p>
    </div>
    <div class="col-auto">
        {% if is_teacher %}

        <a href="{{ url_for('course.create_assignment', course_id=course.id) }}" class="btn btn-primary">
            <i class="fas fa-plus me-1"></i>创建作业
        </a>
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addKnowledgePointModal">
            <i class="fas fa-lightbulb me-1"></i>新增知识点
        </button>
        <a href="{{ url_for('search.add_knowledge', referrer=url_for('course.view', course_id=course.id)) }}"
            class="btn btn-info me-2">
            <i class="fas fa-upload me-1"></i>上传文件资源至知识库
        </a>
        <button type="button" class="btn btn-warning me-2" id="generateTeachingOutlineBtn">
            <i class="fas fa-magic me-1"></i>自动生成教学内容
        </button>
        <a href="{{ url_for('analytics.course_analytics', course_id=course.id) }}" class="btn btn-outline-primary">
            <i class="fas fa-chart-line me-1"></i>课程分析
        </a>
        {% endif %}
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <!-- 课程信息 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>课程详情</h5>
            </div>
            <div class="card-body">
                <p>{{ course.description }}</p>
                <hr>
                <p><strong>教师:</strong> {{ course.teacher.name }}</p>
                {% if is_student %}
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>您已加入该课程
                    <form action="{{ url_for('course.unenroll', course_id=course.id) }}" method="post"
                        style="display: inline-block; float: right;">
                        <button type="submit" class="btn btn-sm btn-outline-danger"
                            onclick="return confirm('确定要退出此课程吗？这可能会影响您的作业和成绩记录。')">
                            <i class="fas fa-user-minus me-1"></i>退出课程
                        </button>
                    </form>
                </div>
                {% elif not is_teacher %}
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle me-2"></i>您尚未加入该课程
                    <form action="{{ url_for('course.enroll', course_id=course.id) }}" method="post"
                        style="display: inline-block; float: right;">
                        <button type="submit" class="btn btn-sm btn-success">
                            <i class="fas fa-user-plus me-1"></i>加入课程
                        </button>
                    </form>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- 知识点列表 (仅教师可见) -->
        {% if is_teacher %}
        <div class="card shadow-sm mb-4">


            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>知识点</h5>
                <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="modal"
                    data-bs-target="#knowledgeGraphModal">
                    查看知识图谱
                </button>
            </div>

            <!-- 知识图谱模态框 -->
            <div class="modal fade" id="knowledgeGraphModal" tabindex="-1" aria-labelledby="knowledgeGraphModalLabel"
                aria-hidden="true">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="knowledgeGraphModalLabel">课程《{{ course.name }}》的知识图谱</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div id="viz"
                                style="width: 100%; height: 600px; border: 1px solid #ccc; border-radius: 8px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body">
                {% if knowledge_points %}
                <div class="table-responsive" style="max-height: 416px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>名称</th>
                                <th>描述</th>
                                <th>所属</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for kp in knowledge_points %}
                            <tr>
                                <td>{{ kp.name }}</td>
                                <td>{{ kp.description|string|default('无')|truncate(50) }}</td>
                                <td>
                                    {% if kp.parent %}
                                    {{ kp.parent.name }}
                                    {% else %}
                                    <span class="text-muted">顶级</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <button type="button" class="btn btn-sm btn-outline-primary"
                                        onclick="editKnowledgePoint({{ kp.id }}, '{{ kp.name }}', '{{ kp.description }}', {% if kp.parent %}{{ kp.parent.id }}{% else %}null{% endif %})">
                                        编辑
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger"
                                        onclick="deleteKnowledgePoint({{ kp.id }}, '{{ kp.name }}')">
                                        删除
                                    </button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-4">该课程暂无知识点，请使用上方"新增知识点"按钮添加</p>
                {% endif %}
            </div>
        </div>
        {% endif %}

        <!-- 作业列表 -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-tasks me-2"></i>作业</h5>
            </div>
            <div class="card-body">
                {% if assignments %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>标题</th>
                                <th>截止日期</th>
                                <th>总分</th>
                                {% if is_student %}
                                <th>状态</th>
                                {% endif %}
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assignment in assignments %}
                            <tr>
                                <td>{{ assignment.title }}</td>
                                <td>{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                                <td>{{ assignment.total_points }}</td>
                                {% if is_student %}
                                {% set student_assignment = student_assignments|selectattr('assignment.id', 'equalto',
                                assignment.id)|first %}
                                <td>
                                    {% if student_assignment and student_assignment.status==1 %}
                                    <span class="badge bg-success">已提交</span>
                                    {% elif student_assignment and (student_assignment.final_score or
                                    student_assignment.status == 2) %}
                                    <span class="badge bg-warning">已批改</span>
                                    {% else %}
                                    <span class="badge bg-danger">未提交</span>
                                    {% endif %}
                                </td>
                                {% endif %}
                                <td>
                                    <a href="{{ url_for('course.view_assignment', assignment_id=assignment.id) }}"
                                        class="btn btn-sm btn-outline-primary">查看</a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center py-4">该课程暂无作业</p>
                {% endif %}
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <!-- 学生列表 (仅教师可见) -->
        {% if is_teacher and students %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-users me-2"></i>学生 ({{ students|length }})</h5>
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    {% for student in students %}
                    <li class="list-group-item d-flex justify-content-between align-items-center">
                        {{ student.name }}
                        <a href="{{ url_for('analytics.student_analytics', student_id=student.id, course_id=course.id) }}"
                            class="btn btn-sm btn-outline-primary">查看分析</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>
        {% endif %}
        <!-- 相关知识库 -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-search me-2"></i>知识库查询</h5>
            </div>
            <!-- 知识库查询卡片 -->
            <div class="card-body">
                <form action="{{ url_for('search.index') }}" method="get">
                    <input type="hidden" name="course_id" value="{{ course.id }}">
                    <div class="input-group">
                        <input type="text" class="form-control" name="q" placeholder="搜索课程相关知识...">
                        <button class="btn btn-primary" type="submit">查询</button>
                    </div>
                </form>
            </div>
            <!-- 课程相关知识条目 -->

            <div class="card shadow-sm mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>课程相关资源</h5>
                </div>
                <div class="card-body">
                    {% if knowledge_entries %}
                    <div class="list-group">
                        {% for entry in knowledge_entries %}
                        <div class="list-group-item">
                            {% if entry.type == 'text' %}
                            <!-- 文本类型：显示标题和内容 -->
                            <h6 class="mb-2">{{ entry.title }}</h6>
                            <div class="text-muted small">
                                {{ entry.content|safe }}
                            </div>
                            {% else %}
                            <!-- 其他类型：显示可点击下载的标题 -->
                            <div class="d-flex align-items-center">
                                <i class="fas {{ 'fa-file-pdf' if entry.type == 'pdf' 
                                                        else 'fa-file-word' if entry.type == 'doc' 
                                                        else 'fa-file-image' if entry.type == 'image'
                                                        else 'fa-file-alt' }} me-2"></i>
                                <a href="{{ entry.content }}">
                                    {{ entry.title }}
                                </a>

                            </div>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="alert alert-info mb-0">暂无相关资源</div>
                    {% endif %}
                </div>
            </div>





        </div>
        <!-- 在右侧学生列表下方添加错题本模块 -->
        {% if is_student %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-bookmark me-2"></i>我的错题本</h5>
            </div>
            <div class="card-body">
                {% if wrong_questions %}
                <div class="accordion" id="wrongQuestionsAccordion">
                    {% for assignment_data in wrong_questions %}
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                data-bs-target="#collapse{{ assignment_data.assignment.id }}">
                                {{ assignment_data.assignment.title }}
                                <span class="badge bg-danger ms-2">{{ assignment_data.questions|length }}</span>
                            </button>
                        </h2>
                        <div id="collapse{{ assignment_data.assignment.id }}" class="accordion-collapse collapse"
                            data-bs-parent="#wrongQuestionsAccordion">
                            <div class="accordion-body p-0">
                                <ul class="list-group list-group-flush">
                                    {% for question in assignment_data.questions %}
                                    <li class="list-group-item">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <span>{{ question.question_name }}</span>
                                            <span class="badge bg-danger">
                                                {{ question.score }}/{{ question.total_points }}
                                            </span>
                                        </div>

                                        <!-- 展开内容 -->
                                        <div class="mt-2 collapse" id="questionDetail{{ question.id }}">
                                            <div class="card bg-light mt-2">
                                                <div class="card-body p-3">
                                                    <h6>题目内容:</h6>
                                                    <p>{{ question.context }}</p>
                                                    <h6 class="mt-2">正确答案:</h6>
                                                    <p>{{ question.answer }}</p>
                                                    <h6 class="mt-2">我的答案:</h6>
                                                    <p>{{ question.student_answer }}</p>
                                                </div>
                                            </div>
                                        </div>

                                        <button class="btn btn-sm btn-outline-primary mt-2" type="button"
                                            data-bs-toggle="collapse" data-bs-target="#questionDetail{{ question.id }}">
                                            查看详情
                                        </button>
                                        <a href="{{ url_for('wrongbook.practice_questions', course_id=course.id, question_id=question.id) }}"
                                            class="btn btn-sm btn-outline-success mt-2 ms-2">
                                                <i class="fas fa-dumbbell me-1"></i>再练几题
                                        </a>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="text-center py-3">
                    <i class="fas fa-check-circle text-success fa-2x mb-2"></i>
                    <p class="mb-0">当前课程没有错题记录</p>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}

    </div>
</div>

<!-- 新增知识点模态框 -->
{% if is_teacher %}
<div class="modal fade" id="addKnowledgePointModal" tabindex="-1" aria-labelledby="addKnowledgePointModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addKnowledgePointModalLabel">新增知识点</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <ul class="nav nav-tabs" id="addKPTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="manual-tab-modal" data-bs-toggle="tab"
                        data-bs-target="#manual-modal" type="button" role="tab" aria-controls="manual-modal"
                        aria-selected="true">手动输入</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="excel-tab-modal" data-bs-toggle="tab" data-bs-target="#excel-modal"
                        type="button" role="tab" aria-controls="excel-modal" aria-selected="false">Excel 导入</button>
                </li>
            </ul>
            <!-- 标签页内容 -->
            <div class="tab-content" id="addKPTabContent">
                <!-- 手动输入页 -->
                <div class="tab-pane fade show active" id="manual-modal" role="tabpanel"
                    aria-labelledby="manual-tab-modal">
                    <form id="addKnowledgePointForm"
                        action="{{ url_for('course.add_knowledge_point', course_id=course.id) }}" method="post">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="kp_name" class="form-label">知识点名称</label>
                                <input type="text" class="form-control" id="kp_name" name="name" required>
                            </div>
                            <div class="mb-3">
                                <label for="kp_description" class="form-label">描述</label>
                                <textarea class="form-control" id="kp_description" name="description"
                                    rows="3"></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="kp_parent" class="form-label">父级知识点（可选）</label>
                                <select class="form-select" id="kp_parent" name="parent_id">
                                    <option value="">-- 无父级（顶级知识点）--</option>
                                    {% for kp in knowledge_points %}
                                    <option value="{{ kp.id }}">{{ kp.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
                <!-- 新增 Excel 导入页 -->
                <div class="tab-pane fade" id="excel-modal" role="tabpanel" aria-labelledby="excel-tab-modal">
                    <form id="importExcelForm"
                        action="{{ url_for('course.import_knowledge_points', course_id=course.id) }}" method="post"
                        enctype="multipart/form-data">
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="excelFile" class="form-label">选择 Excel 文件</label>
                                <input class="form-control" type="file" id="excelFile" name="excel_file"
                                    accept=".xlsx, .xls" required>
                            </div>
                            <div class="alert alert-info">
                                <p>Excel 文件格式要求：</p>
                                <ul>
                                    <li>A列至G列对应知识点的层级关系，区间内每行只能填写一个知识点</li>
                                    <li>I列至K列填写对应知识点的前置、后置和关联知识点，多个知识点之间用英文分号";"隔开</li>
                                    <li>任意两个知识点之间只能存在一种关系（前置、后置或关联），新导入的关系将覆盖旧关系，关系设置总数上限为2000个</li>
                                    <li>L列写固定标签,包括：重点、难点、考点、课程思政，可根据需要自定义标签，多个标签之间用英文分号";"隔开</li>
                                    <li>M列写认知维度,包括：记忆、理解、应用、分析、评价、创造，每个知识点只能填入一个认知维度</li>
                                    <li>N列写知识点分类,包括：事实性、概念性、程序性、元认知，每个知识点只能填入一个分类</li>
                                    <li>O列写知识点说明,仅支持输入文本，暂不支持图片、公式等</li>
                                </ul>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                            <button type="submit" class="btn btn-primary">导入</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>


<!-- 编辑知识点模态框 -->
<div class="modal fade" id="editKnowledgePointModal" tabindex="-1" aria-labelledby="editKnowledgePointModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editKnowledgePointModalLabel">编辑知识点</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editKnowledgePointForm" action="" method="post">
                <div class="modal-body">
                    <input type="hidden" id="edit_kp_id" name="knowledge_point_id">
                    <div class="mb-3">
                        <label for="edit_kp_name" class="form-label">知识点名称</label>
                        <input type="text" class="form-control" id="edit_kp_name" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="edit_kp_description" class="form-label">描述</label>
                        <textarea class="form-control" id="edit_kp_description" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="edit_kp_parent" class="form-label">父级知识点（可选）</label>
                        <select class="form-select" id="edit_kp_parent" name="parent_id">
                            <option value="">-- 无父级（顶级知识点）--</option>
                            {% for kp in knowledge_points %}
                            <option value="{{ kp.id }}">{{ kp.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">更新</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除知识点确认模态框 -->
<div class="modal fade" id="deleteKnowledgePointModal" tabindex="-1" aria-labelledby="deleteKnowledgePointModalLabel"
    aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteKnowledgePointModalLabel">删除知识点</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除知识点 "<span id="delete_kp_name"></span>" 吗？</p>
                <p class="text-danger">注意：这将删除与该知识点的所有关联。如果它有子知识点，将无法删除。</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deleteKnowledgePointForm" action="" method="post">
                    <input type="hidden" id="delete_kp_id" name="knowledge_point_id">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- 生成进度模态框 -->
<div class="modal fade" id="generateProgressModal" tabindex="-1" aria-labelledby="generateProgressModalLabel"
    aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateProgressModalLabel">正在生成教学大纲</h5>
            </div>
            <div class="modal-body text-center">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">生成中...</span>
                </div>
                <p class="mb-0">AI正在分析课程资料并生成教学大纲，请稍候...</p>
                <div class="progress mt-3">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width: 100%"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 生成结果模态框 -->
<div class="modal fade" id="generateResultModal" tabindex="-1" aria-labelledby="generateResultModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="generateResultModalLabel">教学大纲生成完成</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="generateResultContent">
                    <!-- 生成的内容将在这里显示 -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="downloadPdfBtn">
                    <i class="fas fa-download me-1"></i>下载PDF
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 错误提示模态框 -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-labelledby="errorModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="errorModalLabel">生成失败</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage">生成教学大纲时发生错误，请稍后重试。</span>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-tabs .nav-link {
        color: #000 !important;
    }

    .nav-tabs .nav-link.active {
        color: #0d6efd !important;
    }

    /* 教学大纲内容样式 */
    .teaching-outline-content {
        font-family: "Microsoft YaHei", "SimHei", Arial, sans-serif;
        line-height: 1.6;
        color: #333;
    }

    .teaching-outline-content h1 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }

    .teaching-outline-content h2 {
        color: #34495e;
        margin-top: 25px;
        margin-bottom: 15px;
    }

    .teaching-outline-content h3 {
        color: #7f8c8d;
        margin-top: 20px;
        margin-bottom: 10px;
    }

    .teaching-outline-content ul,
    .teaching-outline-content ol {
        margin-left: 20px;
        margin-bottom: 15px;
    }

    .teaching-outline-content li {
        margin-bottom: 5px;
    }

    .teaching-outline-content p {
        margin-bottom: 12px;
        text-align: justify;
    }

    .teaching-outline-content strong {
        color: #2c3e50;
    }

    /* 进度条动画 */
    .progress-bar-animated {
        animation: progress-bar-stripes 1s linear infinite;
    }

    @keyframes progress-bar-stripes {
        0% {
            background-position: 40px 0;
        }

        100% {
            background-position: 0 0;
        }
    }

    /* 按钮悬停效果 */
    #generateTeachingOutlineBtn:hover {
        background-color: #e0a800;
        border-color: #d39e00;
    }

    #generateTeachingOutlineBtn:disabled {
        background-color: #6c757d;
        border-color: #6c757d;
        cursor: not-allowed;
    }

    /* 响应式设计 */
    @media (max-width: 768px) {
        .modal-xl {
            max-width: 95%;
        }

        .teaching-outline-content {
            font-size: 14px;
        }
    }
</style>


<script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>

<script>
    function editKnowledgePoint(id, name, description, parentId) {
        document.getElementById('edit_kp_id').value = id;
        document.getElementById('edit_kp_name').value = name;
        document.getElementById('edit_kp_description').value = description;

        const parentSelect = document.getElementById('edit_kp_parent');
        if (parentId) {
            for (let i = 0; i < parentSelect.options.length; i++) {
                if (parentSelect.options[i].value == parentId) {
                    parentSelect.selectedIndex = i;
                    break;
                }
            }
        } else {
            parentSelect.selectedIndex = 0;
        }

        document.getElementById('editKnowledgePointForm').action =
            "{{ url_for('course.edit_knowledge_point', course_id=course.id) }}";

        // 禁用与当前知识点相同的选项和子知识点选项
        for (let i = 0; i < parentSelect.options.length; i++) {
            parentSelect.options[i].disabled = (parentSelect.options[i].value == id);
        }

        const modal = new bootstrap.Modal(document.getElementById('editKnowledgePointModal'));
        modal.show();
    }

    function deleteKnowledgePoint(id, name) {
        document.getElementById('delete_kp_id').value = id;
        document.getElementById('delete_kp_name').textContent = name;
        document.getElementById('deleteKnowledgePointForm').action =
            "{{ url_for('course.delete_knowledge_point', course_id=course.id) }}";

        const modal = new bootstrap.Modal(document.getElementById('deleteKnowledgePointModal'));
        modal.show();
    }

    document.addEventListener("DOMContentLoaded", function () {
        const modal = document.getElementById("knowledgeGraphModal");
        const courseId = "{{ course.id }}";

        if (!modal) return;

        modal.addEventListener("shown.bs.modal", function () {
            const container = document.getElementById("viz");
            if (!container) return;

            // 清空旧内容，避免多次渲染叠加
            container.innerHTML = "";

            fetch(`/course/${courseId}/view_knowledge_graph`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`请求失败，状态码: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    const nodes = new vis.DataSet(data.nodes);
                    const edges = new vis.DataSet(data.edges);

                    const options = {
                        nodes: {
                            shape: "dot",
                            size: 15,
                            font: { size: 14, color: "#000" }
                        },
                        edges: {
                            arrows: "to",
                            font: { align: "top" }
                        },
                        physics: {
                            stabilization: false,
                            barnesHut: { springLength: 150 }
                        }
                    };

                    new vis.Network(container, { nodes, edges }, options);
                })
                .catch(error => {
                    console.error("知识图谱加载失败:", error);
                    container.innerHTML = "<p class='text-danger'>加载图谱失败，请稍后再试。</p>";
                });
        });
    });
    document.addEventListener('DOMContentLoaded', function () {
        const generateBtn = document.getElementById('generateTeachingOutlineBtn');
        const progressModal = new bootstrap.Modal(document.getElementById('generateProgressModal'));
        const resultModal = new bootstrap.Modal(document.getElementById('generateResultModal'));
        const errorModal = new bootstrap.Modal(document.getElementById('errorModal'));
        const downloadBtn = document.getElementById('downloadPdfBtn');

        let generatedData = null;
        const courseId = "{{ course.id }}";

        // 检查按钮是否存在
        if (!generateBtn) {
            console.error('生成按钮未找到');
            return;
        }

        // 生成教学大纲
        generateBtn.addEventListener('click', function () {
            // 禁用按钮防止重复点击
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>生成中...';

            // 显示进度模态框
            progressModal.show();

            // 发送生成请求
            fetch('/course/api/generate_teaching_outline', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify({
                    course_id: parseInt(courseId)
                }),
                credentials: 'same-origin' // 确保发送cookies
            })
                .then(response => {
                    console.log('Response status:', response.status);
                    console.log('Response headers:', response.headers);

                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.error || `HTTP Error: ${response.status}`);
                        });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data);

                    // 隐藏进度模态框
                    progressModal.hide();

                    if (data.error) {
                        showError(data.error);
                    } else if (data.success) {
                        generatedData = data;
                        showResult(data);
                    } else {
                        showError('响应数据格式错误');
                    }
                })
                .catch(error => {
                    console.error('生成失败:', error);
                    progressModal.hide();

                    // 更详细的错误处理
                    let errorMessage = '生成失败，请重试。';

                    if (error.name === 'TypeError' && error.message.includes('fetch')) {
                        errorMessage = '网络连接失败，请检查网络后重试。';
                    } else if (error.message.includes('HTTP Error: 401')) {
                        errorMessage = '登录已过期，请重新登录。';
                        setTimeout(() => {
                            window.location.href = '/login';
                        }, 2000);
                    } else if (error.message.includes('HTTP Error: 403')) {
                        errorMessage = '没有权限执行此操作。';
                    } else if (error.message.includes('HTTP Error: 404')) {
                        errorMessage = '课程不存在或已被删除。';
                    } else if (error.message.includes('HTTP Error: 500')) {
                        errorMessage = '服务器内部错误，请稍后重试。';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }

                    showError(errorMessage);
                })
                .finally(() => {
                    // 恢复按钮状态
                    generateBtn.disabled = false;
                    generateBtn.innerHTML = '<i class="fas fa-magic me-1"></i>自动生成教学内容';
                });
        });

        // 下载PDF
        downloadBtn.addEventListener('click', function () {
            if (!generatedData || !generatedData.pdf_base64) {
                showError('PDF文件不存在，请重新生成。');
                return;
            }

            try {
                // 创建下载链接
                const byteCharacters = atob(generatedData.pdf_base64);
                const byteNumbers = new Array(byteCharacters.length);
                for (let i = 0; i < byteCharacters.length; i++) {
                    byteNumbers[i] = byteCharacters.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                const blob = new Blob([byteArray], { type: 'application/pdf' });

                // 创建下载链接
                const url = window.URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = generatedData.filename || '教学大纲.pdf';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                window.URL.revokeObjectURL(url);

                // 显示下载成功提示
                showSuccessToast('PDF文件已开始下载');
            } catch (error) {
                console.error('下载失败:', error);
                showError('PDF下载失败，请重新生成后再试。');
            }
        });

        // 显示生成结果
        function showResult(data) {
            const contentDiv = document.getElementById('generateResultContent');

            // 格式化内容显示
            let formattedContent = data.content;

            // 简单的markdown到HTML转换
            formattedContent = formattedContent
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/^# (.*$)/gm, '<h1>$1</h1>')
                .replace(/^## (.*$)/gm, '<h2>$1</h2>')
                .replace(/^### (.*$)/gm, '<h3>$1</h3>')
                .replace(/^#### (.*$)/gm, '<h4>$1</h4>')
                .replace(/^\* (.*$)/gm, '<li>$1</li>')
                .replace(/^(\d+\.) (.*$)/gm, '<li>$2</li>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>');

            // 处理列表
            formattedContent = formattedContent.replace(/(<li>.*<\/li>)/g, function (match) {
                return '<ul>' + match.replace(/<\/li><li>/g, '</li><li>') + '</ul>';
            });

            // 包装段落
            if (!formattedContent.includes('<p>')) {
                formattedContent = '<p>' + formattedContent + '</p>';
            }

            contentDiv.innerHTML = `
            <div class="teaching-outline-content">
                <div class="alert alert-success" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    教学大纲已成功生成！标题：<strong>${data.title}</strong>
                </div>
                <div class="card">
                    <div class="card-body">
                        ${formattedContent}
                    </div>
                </div>
            </div>
        `;

            resultModal.show();
        }

        // 显示错误信息
        function showError(message) {
            const errorMessageElement = document.getElementById('errorMessage');
            if (errorMessageElement) {
                errorMessageElement.textContent = message;
                errorModal.show();
            } else {
                alert(message); // 备用方案
            }
        }

        // 显示成功提示
        function showSuccessToast(message) {
            // 创建临时提示
            const toast = document.createElement('div');
            toast.className = 'alert alert-success position-fixed';
            toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            toast.innerHTML = `
            <i class="fas fa-check-circle me-2"></i>
            ${message}
        `;

            document.body.appendChild(toast);

            // 3秒后自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // 处理模态框关闭事件
        document.getElementById('generateProgressModal').addEventListener('hidden.bs.modal', function () {
            // 进度模态框关闭时的处理
        });

        document.getElementById('generateResultModal').addEventListener('hidden.bs.modal', function () {
            // 结果模态框关闭时的处理
        });

        // 添加调试信息
        console.log('页面加载完成，课程ID:', courseId);
    });

</script>
{% endif %}
{% endblock %}